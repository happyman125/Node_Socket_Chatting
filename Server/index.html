<!DOCTYPE html>
<html>
<head>
<title>Input Name</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
</head>


<body>



<div data-role="page" id='inputNamePage'>
  <div data-role="header">
  <h1>Text Inputs</h1>
  </div>
  <div data-role="main" class="ui-content">
    <form action="">
      <div class="ui-field-contain">
        <label for="fullname">Full name:</label>
        <input type="text" name="fullname" id="fullname">       
      </div>
      <button id="startButton"> OK </button>
    </form>
  </div>
</div>


<div data-role="page" id="listPage">
  <div data-role="main" class="ui-content">
    <h2>Online Users</h2>
    <ol data-role="listview" id="userlist" data-inset="true">
    </ol>
  </div>
</div> 

   <script>

	var startButton = document.getElementById('startButton');
	startButton.onclick = function(){
		window.fullname = $('#fullname').val();
		
		register();
	};
      
    var socket = io();
	var uuid = guid();

	socket.on('register succeed', function(msg){
	  window.socket = socket;
  
	  $.get(
		"listUsers",
		{paramOne : 1, paramX : 'abc'},
		function(data) {
	       users = JSON.parse(data);
		   	location.href='#listPage';
		   //$.mobile.changePage( "#listPage", { transition: "slide", changeHash: false });
			$.each(users, function(index, value){
				appendUser(value);
			});
			$('#userlist').listView('refresh');
		 }
	  );
	});


	socket.on('new user', function(data){
  		appendUser(data);
  		window.setTimeout(function(){ $('#userlist').listview("refresh"); }, 300);
  		//$('#userlist').listView('refresh');
	});
	
	socket.on('user leave', function(data){
		removeUser(data);
		window.setTimeout(function(){ $('#userlist').listview("refresh"); }, 300);
		//$('#userlist').listView('refresh');
	});
	
	socket.on('connect', function(){
  
	});
	

    $('#userlist').on('click', 'li', function() {
        alert($(this).attr('id')); // id of clicked li by directly accessing DOMElement property
    });
    
	function appendUser(user){
		$('#userlist').append('<li id=' + user.id + '><a href="#">' + user.name + '</a></li>');   
		
	};
	
	function removeUser(user){
		$('#' + user.id).remove();
	}

	function guid() {
	return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
	  s4() + '-' + s4() + s4() + s4();
	}

	function s4() {
	return Math.floor((1 + Math.random()) * 0x10000)
	  .toString(16)
	  .substring(1);
	}


	function register(){
		var info = {name: window.fullname, uuid: uuid};
	    socket.emit('register', info);
	}

    </script>
    

    
</body>
</html>

